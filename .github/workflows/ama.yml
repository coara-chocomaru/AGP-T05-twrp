name: Patch TWRP Sources

on:
  push:
    branches:
      - main  # 実行するブランチを指定

env:
  MANIFEST_URL: 'https://github.com/minimal-manifest-twrp/platform_manifest_twrp_omni'
  MANIFEST_BRANCH: 'twrp-9.0'
  DEVICE_TREE_URL: 'https://github.com/coara-chocomaru/test-ctab'
  DEVICE_TREE_BRANCH: 'main'
  DEVICE_PATH: 'device/sts/a05bd'
  DEVICE_NAME: 'a05bd'
  MAKEFILE_NAME: 'omni_a05bd'
  BUILD_TARGET: 'recovery'
  # 必要に応じて指定
  # COMMON_TREE_URL: ''
  # COMMON_PATH: ''

jobs:
  patch:
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-22.04

    permissions:
      contents: write

    steps:
      - name: Display Run Parameters
        run: |
          echo "::group::User Environment Variables"
          echo "Manifest URL: ${{ env.MANIFEST_URL }}"
          echo "Manifest Branch: ${{ env.MANIFEST_BRANCH }}"
          echo "Device Tree URL: ${{ env.DEVICE_TREE_URL }}"
          echo "Device Tree Branch: ${{ env.DEVICE_TREE_BRANCH }}"
          echo "Device Path: ${{ env.DEVICE_PATH }}"
          echo "Device Name: ${{ env.DEVICE_NAME }}"
          echo "Makefile Name: ${{ env.MAKEFILE_NAME }}"
          echo "Build Target: ${{ env.BUILD_TARGET }}.img"
          echo "::endgroup::"

      - name: Check Out
        uses: actions/checkout@v3

      - name: Cleanup
        uses: rokibhasansagar/slimhub_actions@main

      - name: Prepare the environment
        run: |
          sudo apt update
          sudo apt -y upgrade
          sudo apt -y install \
            gperf gcc-multilib gcc-10-multilib g++-multilib g++-10-multilib \
            libc6-dev lib32ncurses5-dev x11proto-core-dev libx11-dev tree \
            lib32z-dev libgl1-mesa-dev libxml2-utils xsltproc bc ccache \
            lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev \
            libsdl1.2-dev libwxgtk3.0-gtk3-dev libxml2 lzop pngcrush \
            schedtool squashfs-tools imagemagick libbz2-dev lzma ncftp \
            qemu-user-static libstdc++-10-dev libncurses5 python3 libtinfo5

      - name: Install OpenJDK
        uses: actions/setup-java@v3
        with:
          distribution: zulu
          java-version: '8'

      - name: Setup SSH Keys
        if: startsWith(env.MANIFEST_URL, 'git@github.com')
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: |
            ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Install repo
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          sudo ln -sf ~/bin/repo /usr/bin/repo

      - name: Initialize repo
        id: pwd
        run: |
          mkdir workspace
          cd workspace
          echo "workspace-folder=$(pwd)" >> "$GITHUB_OUTPUT"
          git config --global user.name "azwhikaru"
          git config --global user.email "azwhikaru+37921907@github.com"
          repo init --depth=1 \
            -u ${{ env.MANIFEST_URL }} \
            -b ${{ env.MANIFEST_BRANCH }}

      - name: Repo Sync
        working-directory: workspace
        run: |
          repo sync -j$(nproc --all) --force-sync

      - name: Move files to workspace
        run: |
          mkdir -p workspace/${{ env.DEVICE_PATH }}
          ls | grep -v workspace | xargs -I{} mv {} workspace/${{ env.DEVICE_PATH }}

      - name: Patch TWRP source for custom command support
        working-directory: workspace
        run: |
          cd bootable/recovery

          cp twrp.cpp twrp.cpp.bak
          cp partition.cpp partition.cpp.bak
          cp openrecoveryscript.cpp openrecoveryscript.cpp.bak

          sed -i '1a #include <string>\n#include <cstdlib>\n#include <cerrno>' twrp.cpp
          sed -i '1a #include <string>\n#include <cstdlib>\n#include <cerrno>' partition.cpp
          sed -i '1a #include <string>\n#include <cerrno>' openrecoveryscript.cpp

          sed -i '/if (strncmp(argv\[arg\], "--w", 3) == 0) {/a \
              if (strncmp(argv[arg], "--wipe_data", 11) == 0) { \
                  int reason_arg = arg + 1; \
                  if (reason_arg < argc && strncmp(argv[reason_arg], "--reason=", 9) == 0) { \
                      std::string reason_str = std::string(argv[reason_arg] + 9); \
                      gui_print("Detected reason: %s. Forcing format before wipe.\\n", reason_str.c_str()); \
                      if (reason_str == "fs_mgr_mount_all") { \
                          OpenRecoveryScript::Insert_ORS_Command("format data\\n"); \
                      } \
                  } \
                  OpenRecoveryScript::Insert_ORS_Command("format data\\n"); \
                  OpenRecoveryScript::Insert_ORS_Command("wipe data\\n"); \
                  arg = reason_arg; \
              }' twrp.cpp

          sed -i '/printf("\\n");/a \
              PartitionManager.Mount_By_Path("/data", true); \
              TWPartition* data = PartitionManager.Find_Partition_By_Path("/data"); \
              if (data && !data->Is_Mounted()) { \
                  gui_print("Boot-time /data mount failed (Invalid argument). Forcing format...\\n"); \
                  PartitionManager.Format_Data(); \
                  PartitionManager.Wipe_By_Path("/data"); \
                  PartitionManager.Mount_By_Path("/data", true); \
              }' twrp.cpp

          sed -i '/if (mount(Actual_Block_Device.c_str(), Mount_Point.c_str(), mount_fs.c_str(), flags, NULL) != 0) {/a \
              if (Mount_Point == "/data") { \
                  gui_print("Data mount failed (errno=%d). Forcing format before cache wipe.\\n", errno); \
                  if (errno == 22 && TWFunc::Path_Exists("/data/misc/vold/user_keys")) { \
                      gui_print("Trying FBE decrypt...\\n"); \
                      DataManager::Decrypt_Data(); \
                  } \
                  Format(); \
                  PartitionManager.Wipe_By_Path("/data"); \
                  gui_print("Format and wipe completed for /data.\\n"); \
                  if (mount(Actual_Block_Device.c_str(), Mount_Point.c_str(), mount_fs.c_str(), flags, NULL) == 0) { \
                      return true; \
                  } \
              }' partition.cpp

          sed -i '/if (strcmp(value, "data") == 0) {/a \
              gui_msg("force_format_data=Forcing format data before wipe to avoid loop."); \
              if (!PartitionManager.Format_By_Path("/data")) { \
                  gui_err("format_data_failed=Failed to format data."); \
                  ret_val = 1; \
              } else { \
                  if (PartitionManager.Wipe_By_Path("/data")) { \
                      gui_msg("wipe_data_success=Wipe data success after format."); \
                  } else { \
                      gui_err("wipe_data_failed=Wipe data failed."); \
                      ret_val = 1; \
                  } \
              }' openrecoveryscript.cpp

      - name: Create ZIP of Patched Files
        working-directory: workspace
        run: |
          zip -r patched_files.zip \
            bootable/recovery/twrp.cpp \
            bootable/recovery/twrp.cpp.bak \
            bootable/recovery/partition.cpp \
            bootable/recovery/partition.cpp.bak \
            bootable/recovery/openrecoveryscript.cpp \
            bootable/recovery/openrecoveryscript.cpp.bak

      - name: Upload Patched Files as Artifact
        uses: actions/upload-artifact@v3
        with:
          name: patched_files
          path: workspace/patched_files.zip
